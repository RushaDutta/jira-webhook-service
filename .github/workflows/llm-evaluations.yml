name: LLM Feedback Evaluation

# Trigger conditions
on:
  # Scheduled execution (cron)
  schedule:
    # Runs every 2 hours at minute 0
    # Format: minute hour day month day-of-week (all in UTC)
    - cron: '0 */2 * * *'
  
  # Manual trigger from GitHub UI
  workflow_dispatch:
  
  # Optional: Trigger on push to main (for testing)
  # push:
  #   branches: [ main ]

# Define jobs
jobs:
  evaluate-feedback:
    name: Evaluate Jira Feedback with LLM
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: Set up Python environment
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # Cache pip dependencies for faster builds
      
      # Step 3: Install Python dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 3.5: Debug print secrets and env (do not expose actual secrets in production logs)
      - name: Debug Environment and Credentials
        run: |
          echo "GOOGLE_SHEET_NAME=${GOOGLE_SHEET_NAME}"
          echo "GOOGLE_CREDENTIALS_JSON: Length=${#GOOGLE_CREDENTIALS_JSON}"
          echo "OPENROUTER_MODEL=${OPENROUTER_MODEL}"
          echo "OPENROUTER_API_KEY: Set=${{ secrets.OPENROUTER_API_KEY != '' }}"
          # Dump credential fields without printing actual keys
          echo "$GOOGLE_CREDENTIALS_JSON" | jq 'del(.private_key, .client_email, .client_id)' || echo "jq not available"
        env:
          GOOGLE_SHEET_NAME: ${{ secrets.GOOGLE_SHEET_NAME }}
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}
      
      # Step 4: Run the evaluation script
      - name: Run LLM evaluation
        env:
          # Environment variables from GitHub Secrets
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}
          GOOGLE_SHEET_NAME: ${{ secrets.GOOGLE_SHEET_NAME }}
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          SITE_URL: 'https://github.com/${{ github.repository }}'
          SITE_NAME: 'Jira Feedback Processor'
        run: |
          echo "Starting LLM evaluation..."
          python process_feedback.py
          echo "Evaluation completed!"
      
      # Step 5: Upload logs as artifacts (optional but recommended)
      - name: Upload execution logs
        if: always()  # Run even if previous steps fail
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-logs-${{ github.run_number }}
          path: |
            *.log
            *.txt
          retention-days: 7
          if-no-files-found: ignore
      
      # Step 6: Notify on failure (optional)
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Evaluation failed! Check the logs above."
          echo "Run number: ${{ github.run_number }}"
          echo "Triggered by: ${{ github.event_name }}"
