name: LLM Feedback Evaluation

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:
  # Optionally enable on push

jobs:
  evaluate-feedback:
    name: Evaluate Jira Feedback with LLM
    runs-on: ubuntu-latest
    
    steps:
      # Checkout with credentials to allow git push
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Debug Environment and Credentials
        run: |
          echo "GOOGLE_SHEET_NAME=${GOOGLE_SHEET_NAME}"
          echo "GOOGLE_CREDENTIALS_JSON: Length=${#GOOGLE_CREDENTIALS_JSON}"
          echo "OPENROUTER_MODEL=${OPENROUTER_MODEL}"
          echo "OPENROUTER_API_KEY: Set=${{ secrets.OPENROUTER_API_KEY != '' }}"
          echo "$GOOGLE_CREDENTIALS_JSON" | jq 'del(.private_key, .client_email, .client_id)' || echo "jq not available"
        env:
          GOOGLE_SHEET_NAME: ${{ secrets.GOOGLE_SHEET_NAME }}
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}

      - name: Run LLM evaluation
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}
          GOOGLE_SHEET_NAME: ${{ secrets.GOOGLE_SHEET_NAME }}
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          SITE_URL: 'https://github.com/${{ github.repository }}'
          SITE_NAME: 'Jira Feedback Processor'
        run: |
          echo "Starting LLM evaluation..."
          python process_feedback.py
          echo "Evaluation completed!"

      - name: Upload execution logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-logs-${{ github.run_number }}
          path: |
            *.log
            *.txt
          retention-days: 7
          if-no-files-found: ignore
      
      # ---- NEW: Auto-commit HTML report ----
      - name: Commit and push HTML reports
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/
          git commit -m "Update LLM evaluation HTML report [skip ci]" || echo "Nothing to commit"
          git push

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Evaluation failed! Check the logs above."
          echo "Run number: ${{ github.run_number }}"
          echo "Triggered by: ${{ github.event_name }}"
